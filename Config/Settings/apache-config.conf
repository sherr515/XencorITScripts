# =============================================================================
# Apache Web Server Configuration
# =============================================================================
# Purpose: Secure and optimized Apache web server configuration
# Author: System Administrator
# Version: 1.0.0
# Date: $(date +%Y-%m-%d)
# =============================================================================

# Apache Main Configuration File
# This configuration implements security best practices and performance optimization
# Copy this file to /etc/apache2/apache2.conf and restart apache2 service

# =============================================================================
# GLOBAL SETTINGS
# =============================================================================

# Server root directory
ServerRoot "/etc/apache2"

# Pid file
PidFile ${APACHE_PID_FILE}

# Timeout settings
Timeout 300
KeepAlive On
MaxKeepAliveRequests 100
KeepAliveTimeout 5

# Worker settings
User ${APACHE_RUN_USER}
Group ${APACHE_RUN_GROUP}

# Hostname lookup
HostnameLookups Off

# =============================================================================
# MODULE SETTINGS
# =============================================================================

# Load essential modules
LoadModule access_compat_module modules/mod_access_compat.so
LoadModule authz_core_module modules/mod_authz_core.so
LoadModule authz_host_module modules/mod_authz_host.so
LoadModule authz_user_module modules/mod_authz_user.so
LoadModule auth_basic_module modules/mod_auth_basic.so
LoadModule authn_file_module modules/mod_authn_file.so
LoadModule authn_core_module modules/mod_authn_core.so
LoadModule authz_groupfile_module modules/mod_authz_groupfile.so
LoadModule include_module modules/mod_include.so
LoadModule log_config_module modules/mod_log_config.so
LoadModule env_module modules/mod_env.so
LoadModule headers_module modules/mod_headers.so
LoadModule setenvif_module modules/mod_setenvif.so
LoadModule version_module modules/mod_version.so
LoadModule unixd_module modules/mod_unixd.so
LoadModule status_module modules/mod_status.so
LoadModule autoindex_module modules/mod_autoindex.so
LoadModule dir_module modules/mod_dir.so
LoadModule alias_module modules/mod_alias.so
LoadModule rewrite_module modules/mod_rewrite.so
LoadModule ssl_module modules/mod_ssl.so
LoadModule deflate_module modules/mod_deflate.so
LoadModule filter_module modules/mod_filter.so
LoadModule expires_module modules/mod_expires.so
LoadModule mime_module modules/mod_mime.so
LoadModule mime_magic_module modules/mod_mime_magic.so
LoadModule negotiation_module modules/mod_negotiation.so
LoadModule sendfile_module modules/mod_sendfile.so
LoadModule security2_module modules/mod_security2.so

# =============================================================================
# LOGGING CONFIGURATION
# =============================================================================

# Log format definitions
LogFormat "%v:%p %h %l %u %t \"%r\" %>s %O \"%{Referer}i\" \"%{User-Agent}i\"" vhost_combined
LogFormat "%h %l %u %t \"%r\" %>s %O \"%{Referer}i\" \"%{User-Agent}i\"" combined
LogFormat "%h %l %u %t \"%r\" %>s %O" common
LogFormat "%{Referer}i -> %U" referer
LogFormat "%{User-agent}i" agent

# Access log
CustomLog ${APACHE_LOG_DIR}/access.log combined

# Error log
ErrorLog ${APACHE_LOG_DIR}/error.log

# Log level
LogLevel warn

# =============================================================================
# SECURITY SETTINGS
# =============================================================================

# Server tokens (hide version)
ServerTokens Prod
ServerSignature Off

# Security headers
Header always set X-Frame-Options "SAMEORIGIN"
Header always set X-Content-Type-Options "nosniff"
Header always set X-XSS-Protection "1; mode=block"
Header always set Referrer-Policy "no-referrer-when-downgrade"
Header always set Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"

# Disable directory browsing
Options -Indexes

# Disable server-side includes
Options -Includes

# Disable CGI execution
Options -ExecCGI

# =============================================================================
# PERFORMANCE SETTINGS
# =============================================================================

# Enable sendfile
EnableSendfile On

# Enable compression
<IfModule mod_deflate.c>
    AddOutputFilterByType DEFLATE text/plain
    AddOutputFilterByType DEFLATE text/html
    AddOutputFilterByType DEFLATE text/xml
    AddOutputFilterByType DEFLATE text/css
    AddOutputFilterByType DEFLATE application/xml
    AddOutputFilterByType DEFLATE application/xhtml+xml
    AddOutputFilterByType DEFLATE application/rss+xml
    AddOutputFilterByType DEFLATE application/javascript
    AddOutputFilterByType DEFLATE application/x-javascript
    AddOutputFilterByType DEFLATE application/json
    BrowserMatch ^Mozilla/4 gzip-only-text/html
    BrowserMatch ^Mozilla/4\.0[678] no-gzip
    BrowserMatch \bMSIE !no-gzip !gzip-only-text/html
    Header append Vary User-Agent
</IfModule>

# Enable caching
<IfModule mod_expires.c>
    ExpiresActive On
    ExpiresByType text/css "access plus 1 year"
    ExpiresByType application/javascript "access plus 1 year"
    ExpiresByType image/png "access plus 1 year"
    ExpiresByType image/jpg "access plus 1 year"
    ExpiresByType image/jpeg "access plus 1 year"
    ExpiresByType image/gif "access plus 1 year"
    ExpiresByType image/ico "access plus 1 year"
    ExpiresByType image/icon "access plus 1 year"
    ExpiresByType text/plain "access plus 1 month"
    ExpiresByType application/pdf "access plus 1 month"
    ExpiresByType application/x-shockwave-flash "access plus 1 month"
    ExpiresByType image/x-icon "access plus 1 year"
    ExpiresDefault "access plus 2 days"
</IfModule>

# =============================================================================
# VIRTUAL HOST CONFIGURATIONS
# =============================================================================

# Include virtual host configurations
IncludeOptional mods-enabled/*.load
IncludeOptional mods-enabled/*.conf
IncludeOptional conf-enabled/*.conf
IncludeOptional sites-enabled/*.conf

# =============================================================================
# DEFAULT VIRTUAL HOST
# =============================================================================

<VirtualHost *:80>
    ServerName example.com
    ServerAlias www.example.com
    DocumentRoot /var/www/html
    
    # Security settings
    ServerAdmin webmaster@example.com
    ServerTokens Prod
    
    # Logging
    ErrorLog ${APACHE_LOG_DIR}/example.com_error.log
    CustomLog ${APACHE_LOG_DIR}/example.com_access.log combined
    
    # Directory settings
    <Directory /var/www/html>
        Options -Indexes -FollowSymLinks
        AllowOverride All
        Require all granted
        
        # Security headers
        Header always set X-Frame-Options "SAMEORIGIN"
        Header always set X-Content-Type-Options "nosniff"
        Header always set X-XSS-Protection "1; mode=block"
        Header always set Referrer-Policy "no-referrer-when-downgrade"
    </Directory>
    
    # Deny access to sensitive files
    <FilesMatch "\.(htaccess|htpasswd|ini|log|sh|inc|bak)$">
        Require all denied
    </FilesMatch>
    
    # PHP settings
    <FilesMatch \.php$>
        SetHandler application/x-httpd-php
    </FilesMatch>
    
    # Redirect to HTTPS
    RewriteEngine On
    RewriteCond %{HTTPS} off
    RewriteRule ^(.*)$ https://%{HTTP_HOST}%{REQUEST_URI} [L,R=301]
</VirtualHost>

# =============================================================================
# HTTPS VIRTUAL HOST
# =============================================================================

<VirtualHost *:443>
    ServerName example.com
    ServerAlias www.example.com
    DocumentRoot /var/www/html
    
    # SSL Configuration
    SSLEngine on
    SSLCertificateFile /etc/ssl/certs/example.com.crt
    SSLCertificateKeyFile /etc/ssl/private/example.com.key
    SSLCertificateChainFile /etc/ssl/certs/example.com-chain.crt
    
    # SSL Security Settings
    SSLProtocol all -SSLv2 -SSLv3 -TLSv1 -TLSv1.1
    SSLCipherSuite ECDHE-RSA-AES128-GCM-SHA256:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-RSA-AES128-SHA256:ECDHE-RSA-AES256-SHA384
    SSLHonorCipherOrder on
    SSLCompression off
    SSLSessionTickets off
    
    # HSTS
    Header always set Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
    
    # Security headers
    Header always set X-Frame-Options "SAMEORIGIN"
    Header always set X-Content-Type-Options "nosniff"
    Header always set X-XSS-Protection "1; mode=block"
    Header always set Referrer-Policy "no-referrer-when-downgrade"
    Header always set Content-Security-Policy "default-src 'self' http: https: data: blob: 'unsafe-inline'"
    
    # Logging
    ErrorLog ${APACHE_LOG_DIR}/example.com_ssl_error.log
    CustomLog ${APACHE_LOG_DIR}/example.com_ssl_access.log combined
    
    # Directory settings
    <Directory /var/www/html>
        Options -Indexes -FollowSymLinks
        AllowOverride All
        Require all granted
    </Directory>
    
    # API endpoints
    <Location /api>
        ProxyPass http://127.0.0.1:8001/
        ProxyPassReverse http://127.0.0.1:8001/
        
        # Rate limiting
        SetEnvIf Remote_Addr "^192\.168\.1\." local
        SetEnvIf Remote_Addr "^10\.0\.0\." local
        
        # Allow local requests
        Require env local
        Require ip 127.0.0.1
    </Location>
    
    # Admin panel (restricted)
    <Location /admin>
        AuthType Basic
        AuthName "Admin Area"
        AuthUserFile /etc/apache2/.htpasswd
        Require valid-user
        
        # IP restriction
        Require ip 192.168.1.0/24
        Require ip 10.0.0.0/8
    </Location>
    
    # Deny access to sensitive files
    <FilesMatch "\.(htaccess|htpasswd|ini|log|sh|inc|bak)$">
        Require all denied
    </FilesMatch>
    
    # PHP settings
    <FilesMatch \.php$>
        SetHandler application/x-httpd-php
    </FilesMatch>
</VirtualHost>

# =============================================================================
# ADMIN PANEL VIRTUAL HOST
# =============================================================================

<VirtualHost *:443>
    ServerName admin.example.com
    DocumentRoot /var/www/admin
    
    # SSL Configuration
    SSLEngine on
    SSLCertificateFile /etc/ssl/certs/admin.example.com.crt
    SSLCertificateKeyFile /etc/ssl/private/admin.example.com.key
    SSLCertificateChainFile /etc/ssl/certs/admin.example.com-chain.crt
    
    # SSL Security Settings
    SSLProtocol all -SSLv2 -SSLv3 -TLSv1 -TLSv1.1
    SSLCipherSuite ECDHE-RSA-AES128-GCM-SHA256:ECDHE-RSA-AES256-GCM-SHA384
    SSLHonorCipherOrder on
    SSLCompression off
    SSLSessionTickets off
    
    # Security headers
    Header always set X-Frame-Options "DENY"
    Header always set X-Content-Type-Options "nosniff"
    Header always set X-XSS-Protection "1; mode=block"
    Header always set Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
    
    # IP restriction
    Require ip 192.168.1.0/24
    Require ip 10.0.0.0/8
    Require ip 172.16.0.0/12
    
    # Logging
    ErrorLog ${APACHE_LOG_DIR}/admin.example.com_error.log
    CustomLog ${APACHE_LOG_DIR}/admin.example.com_access.log combined
    
    # Directory settings
    <Directory /var/www/admin>
        Options -Indexes -FollowSymLinks
        AllowOverride All
        Require all granted
    </Directory>
</VirtualHost>

# =============================================================================
# API VIRTUAL HOST
# =============================================================================

<VirtualHost *:443>
    ServerName api.example.com
    DocumentRoot /var/www/api
    
    # SSL Configuration
    SSLEngine on
    SSLCertificateFile /etc/ssl/certs/api.example.com.crt
    SSLCertificateKeyFile /etc/ssl/private/api.example.com.key
    SSLCertificateChainFile /etc/ssl/certs/api.example.com-chain.crt
    
    # SSL Security Settings
    SSLProtocol all -SSLv2 -SSLv3 -TLSv1 -TLSv1.1
    SSLCipherSuite ECDHE-RSA-AES128-GCM-SHA256:ECDHE-RSA-AES256-GCM-SHA384
    SSLHonorCipherOrder on
    SSLCompression off
    SSLSessionTickets off
    
    # CORS headers
    Header always set Access-Control-Allow-Origin "*"
    Header always set Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS"
    Header always set Access-Control-Allow-Headers "DNT,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,Range,Authorization"
    
    # Security headers
    Header always set X-Frame-Options "DENY"
    Header always set X-Content-Type-Options "nosniff"
    Header always set X-XSS-Protection "1; mode=block"
    
    # Logging
    ErrorLog ${APACHE_LOG_DIR}/api.example.com_error.log
    CustomLog ${APACHE_LOG_DIR}/api.example.com_access.log combined
    
    # Directory settings
    <Directory /var/www/api>
        Options -Indexes -FollowSymLinks
        AllowOverride All
        Require all granted
    </Directory>
    
    # Handle CORS preflight
    RewriteEngine On
    RewriteCond %{REQUEST_METHOD} OPTIONS
    RewriteRule ^(.*)$ $1 [R=200,L]
</VirtualHost>

# =============================================================================
# MAINTENANCE VIRTUAL HOST
# =============================================================================

<VirtualHost *:80>
    ServerName maintenance.example.com
    DocumentRoot /var/www/maintenance
    
    # Logging
    ErrorLog ${APACHE_LOG_DIR}/maintenance_error.log
    CustomLog ${APACHE_LOG_DIR}/maintenance_access.log combined
    
    # Directory settings
    <Directory /var/www/maintenance>
        Options -Indexes -FollowSymLinks
        AllowOverride None
        Require all granted
    </Directory>
    
    # Allow access to maintenance team
    <Location /admin>
        Require ip 192.168.1.0/24
        Require ip 10.0.0.0/8
        Deny from all
    </Location>
</VirtualHost>

# =============================================================================
# MOD_SECURITY CONFIGURATION
# =============================================================================

<IfModule mod_security2.c>
    # Basic ModSecurity settings
    SecRuleEngine On
    SecRequestBodyAccess On
    SecRequestBodyLimit 13107200
    SecRequestBodyNoFilesLimit 131072
    SecRequestBodyInMemoryLimit 131072
    SecRequestBodyLimitAction Reject
    SecRule REQUEST_HEADERS:Content-Type "text/xml" \
        "id:'200000',phase:1,t:none,t:lowercase,pass,nolog,ctl:requestBodyProcessor=XML"
    
    # SQL Injection protection
    SecRule ARGS "@detectSQLi" \
        "id:942100,\
        phase:2,\
        block,\
        t:none,\
        log,\
        msg:'SQL Injection Attack Detected',\
        logdata:'Matched Data: %{MATCHED_VAR} found within %{MATCHED_VAR_NAME}'"
    
    # XSS protection
    SecRule ARGS "@detectXSS" \
        "id:941100,\
        phase:2,\
        block,\
        t:none,\
        log,\
        msg:'XSS Attack Detected',\
        logdata:'Matched Data: %{MATCHED_VAR} found within %{MATCHED_VAR_NAME}'"
    
    # File upload protection
    SecRule FILES_TMPNAMES "@inspectFile" \
        "id:200000,\
        phase:2,\
        block,\
        t:none,\
        log,\
        msg:'Suspicious file upload detected',\
        logdata:'Matched Data: %{MATCHED_VAR} found within %{MATCHED_VAR_NAME}'"
</IfModule>

# =============================================================================
# RATE LIMITING
# =============================================================================

# Rate limiting using mod_ratelimit
<IfModule mod_ratelimit.c>
    # General rate limiting
    <Location />
        SetOutputFilter RATE_LIMIT
        SetEnv rate-limit 400
    </Location>
    
    # API rate limiting
    <Location /api>
        SetOutputFilter RATE_LIMIT
        SetEnv rate-limit 100
    </Location>
    
    # Login rate limiting
    <Location /login>
        SetOutputFilter RATE_LIMIT
        SetEnv rate-limit 10
    </Location>
</IfModule>

# =============================================================================
# ERROR PAGES
# =============================================================================

# Custom error pages
ErrorDocument 400 /error/400.html
ErrorDocument 401 /error/401.html
ErrorDocument 403 /error/403.html
ErrorDocument 404 /error/404.html
ErrorDocument 500 /error/500.html
ErrorDocument 502 /error/502.html
ErrorDocument 503 /error/503.html

# =============================================================================
# MONITORING AND STATUS
# =============================================================================

# Server status (restricted access)
<Location /server-status>
    SetHandler server-status
    Require ip 127.0.0.1
    Require ip 192.168.1.0/24
    Require ip 10.0.0.0/8
</Location>

# =============================================================================
# CONFIGURATION NOTES
# =============================================================================

# After making changes to this configuration:
# 1. Test the configuration: apache2ctl configtest
# 2. Restart Apache: systemctl restart apache2
# 3. Monitor logs: tail -f /var/log/apache2/error.log
# 4. Test SSL configuration: openssl s_client -connect example.com:443

# Security recommendations:
# - Use strong SSL/TLS configuration
# - Implement ModSecurity rules
# - Use security headers
# - Regular security audits
# - Keep Apache updated
# - Monitor access logs
# - Use fail2ban for additional protection

# Performance recommendations:
# - Enable compression
# - Use caching strategies
# - Monitor performance metrics
# - Optimize worker processes
# - Use keep-alive connections

# =============================================================================
# MONITORING COMMANDS
# =============================================================================

# Check Apache status
# systemctl status apache2

# Test configuration
# apache2ctl configtest

# Check Apache processes
# ps aux | grep apache

# Monitor access logs
# tail -f /var/log/apache2/access.log

# Monitor error logs
# tail -f /var/log/apache2/error.log

# Check SSL certificate
# openssl s_client -connect example.com:443 -servername example.com

# Check ModSecurity logs
# tail -f /var/log/apache2/modsec_audit.log

# =============================================================================
# BACKUP AND RESTORE
# =============================================================================

# Backup configuration
# cp /etc/apache2/apache2.conf /etc/apache2/apache2.conf.backup

# Restore configuration
# cp /etc/apache2/apache2.conf.backup /etc/apache2/apache2.conf

# Backup SSL certificates
# cp -r /etc/ssl/certs/ /backup/ssl/certs/
# cp -r /etc/ssl/private/ /backup/ssl/private/ 