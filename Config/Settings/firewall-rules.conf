# =============================================================================
# Firewall Configuration Rules
# =============================================================================
# Purpose: Comprehensive firewall rules with security best practices
# Author: System Administrator
# Version: 1.0.0
# Date: $(date +%Y-%m-%d)
# =============================================================================

# Firewall Configuration File
# This configuration provides comprehensive firewall rules for various services
# Compatible with iptables, ufw, and firewalld

# =============================================================================
# VARIABLES AND CONSTANTS
# =============================================================================

# Network interfaces
INTERNAL_IFACE="eth0"
EXTERNAL_IFACE="eth1"
WIFI_IFACE="wlan0"

# Network ranges
INTERNAL_NETWORK="192.168.1.0/24"
DMZ_NETWORK="10.0.0.0/24"
VPN_NETWORK="172.16.0.0/24"

# Service ports
SSH_PORT="22"
HTTP_PORT="80"
HTTPS_PORT="443"
DNS_PORT="53"
SMTP_PORT="25"
IMAP_PORT="143"
POP3_PORT="110"
FTP_PORT="21"
SFTP_PORT="22"
NTP_PORT="123"
SNMP_PORT="161"
LDAP_PORT="389"
LDAPS_PORT="636"
MYSQL_PORT="3306"
POSTGRESQL_PORT="5432"
REDIS_PORT="6379"
MONGODB_PORT="27017"
ELASTICSEARCH_PORT="9200"
KIBANA_PORT="5601"
GRAFANA_PORT="3000"
PROMETHEUS_PORT="9090"

# =============================================================================
# IPTABLES CONFIGURATION
# =============================================================================

# Flush existing rules
iptables -F
iptables -X
iptables -t nat -F
iptables -t nat -X
iptables -t mangle -F
iptables -t mangle -X

# Set default policies
iptables -P INPUT DROP
iptables -P FORWARD DROP
iptables -P OUTPUT ACCEPT

# =============================================================================
# INPUT CHAIN RULES
# =============================================================================

# Allow loopback traffic
iptables -A INPUT -i lo -j ACCEPT

# Allow established and related connections
iptables -A INPUT -m state --state ESTABLISHED,RELATED -j ACCEPT

# Allow ICMP (ping)
iptables -A INPUT -p icmp --icmp-type echo-request -j ACCEPT
iptables -A INPUT -p icmp --icmp-type echo-reply -j ACCEPT
iptables -A INPUT -p icmp --icmp-type destination-unreachable -j ACCEPT
iptables -A INPUT -p icmp --icmp-type time-exceeded -j ACCEPT

# SSH access (restrict to internal network)
iptables -A INPUT -p tcp --dport $SSH_PORT -s $INTERNAL_NETWORK -j ACCEPT
iptables -A INPUT -p tcp --dport $SSH_PORT -s $VPN_NETWORK -j ACCEPT

# Web services
iptables -A INPUT -p tcp --dport $HTTP_PORT -j ACCEPT
iptables -A INPUT -p tcp --dport $HTTPS_PORT -j ACCEPT

# DNS service
iptables -A INPUT -p udp --dport $DNS_PORT -j ACCEPT
iptables -A INPUT -p tcp --dport $DNS_PORT -j ACCEPT

# Email services
iptables -A INPUT -p tcp --dport $SMTP_PORT -j ACCEPT
iptables -A INPUT -p tcp --dport $IMAP_PORT -j ACCEPT
iptables -A INPUT -p tcp --dport $POP3_PORT -j ACCEPT

# Database services (restrict to internal network)
iptables -A INPUT -p tcp --dport $MYSQL_PORT -s $INTERNAL_NETWORK -j ACCEPT
iptables -A INPUT -p tcp --dport $POSTGRESQL_PORT -s $INTERNAL_NETWORK -j ACCEPT
iptables -A INPUT -p tcp --dport $REDIS_PORT -s $INTERNAL_NETWORK -j ACCEPT
iptables -A INPUT -p tcp --dport $MONGODB_PORT -s $INTERNAL_NETWORK -j ACCEPT

# Monitoring services (restrict to internal network)
iptables -A INPUT -p tcp --dport $ELASTICSEARCH_PORT -s $INTERNAL_NETWORK -j ACCEPT
iptables -A INPUT -p tcp --dport $KIBANA_PORT -s $INTERNAL_NETWORK -j ACCEPT
iptables -A INPUT -p tcp --dport $GRAFANA_PORT -s $INTERNAL_NETWORK -j ACCEPT
iptables -A INPUT -p tcp --dport $PROMETHEUS_PORT -s $INTERNAL_NETWORK -j ACCEPT

# NTP service
iptables -A INPUT -p udp --dport $NTP_PORT -j ACCEPT

# LDAP services (restrict to internal network)
iptables -A INPUT -p tcp --dport $LDAP_PORT -s $INTERNAL_NETWORK -j ACCEPT
iptables -A INPUT -p tcp --dport $LDAPS_PORT -s $INTERNAL_NETWORK -j ACCEPT

# SNMP service (restrict to monitoring network)
iptables -A INPUT -p udp --dport $SNMP_PORT -s $INTERNAL_NETWORK -j ACCEPT

# =============================================================================
# FORWARD CHAIN RULES
# =============================================================================

# Allow forwarding for internal networks
iptables -A FORWARD -i $INTERNAL_IFACE -o $EXTERNAL_IFACE -j ACCEPT
iptables -A FORWARD -i $EXTERNAL_IFACE -o $INTERNAL_IFACE -m state --state ESTABLISHED,RELATED -j ACCEPT

# DMZ forwarding rules
iptables -A FORWARD -i $INTERNAL_IFACE -o $DMZ_NETWORK -j ACCEPT
iptables -A FORWARD -i $DMZ_NETWORK -o $INTERNAL_IFACE -m state --state ESTABLISHED,RELATED -j ACCEPT

# VPN forwarding rules
iptables -A FORWARD -i $VPN_NETWORK -o $INTERNAL_NETWORK -j ACCEPT
iptables -A FORWARD -i $INTERNAL_NETWORK -o $VPN_NETWORK -j ACCEPT

# =============================================================================
# NAT RULES
# =============================================================================

# Enable NAT for internal network
iptables -t nat -A POSTROUTING -o $EXTERNAL_IFACE -j MASQUERADE

# Port forwarding examples (uncomment and modify as needed)
# iptables -t nat -A PREROUTING -p tcp --dport 8080 -j DNAT --to-destination 192.168.1.100:80
# iptables -t nat -A PREROUTING -p tcp --dport 8443 -j DNAT --to-destination 192.168.1.100:443

# =============================================================================
# RATE LIMITING RULES
# =============================================================================

# Limit SSH connections to prevent brute force attacks
iptables -A INPUT -p tcp --dport $SSH_PORT -m recent --name SSH --set
iptables -A INPUT -p tcp --dport $SSH_PORT -m recent --name SSH --update --seconds 60 --hitcount 4 -j DROP

# Limit HTTP connections
iptables -A INPUT -p tcp --dport $HTTP_PORT -m limit --limit 25/minute --limit-burst 100 -j ACCEPT

# Limit HTTPS connections
iptables -A INPUT -p tcp --dport $HTTPS_PORT -m limit --limit 25/minute --limit-burst 100 -j ACCEPT

# =============================================================================
# LOGGING RULES
# =============================================================================

# Log dropped packets
iptables -A INPUT -j LOG --log-prefix "IPTABLES-DROPPED: "
iptables -A FORWARD -j LOG --log-prefix "IPTABLES-FORWARD-DROPPED: "

# =============================================================================
# UFW CONFIGURATION
# =============================================================================

# UFW configuration file (/etc/ufw/ufw.conf)
# Default incoming policy
DEFAULT_INPUT_POLICY="DROP"

# Default outgoing policy
DEFAULT_OUTPUT_POLICY="ACCEPT"

# Default forwarded policy
DEFAULT_FORWARD_POLICY="DROP"

# Log level
LOGLEVEL="LOW"

# =============================================================================
# UFW RULES
# =============================================================================

# Basic UFW rules (add to /etc/ufw/user.rules)
# Allow SSH
ufw allow 22/tcp

# Allow HTTP/HTTPS
ufw allow 80/tcp
ufw allow 443/tcp

# Allow DNS
ufw allow 53/udp
ufw allow 53/tcp

# Allow SMTP
ufw allow 25/tcp

# Allow IMAP/POP3
ufw allow 143/tcp
ufw allow 110/tcp

# Allow NTP
ufw allow 123/udp

# =============================================================================
# FIREWALLD CONFIGURATION
# =============================================================================

# Firewalld configuration file (/etc/firewalld/firewalld.conf)
# Default zone
DefaultZone=public

# Minimal firewall
MinimalFirewall=no

# Clean up on exit
CleanupOnExit=yes

# Lockdown
Lockdown=no

# IPv6 support
IPv6_rpfilter=yes

# =============================================================================
# FIREWALLD ZONES
# =============================================================================

# Public zone configuration (/etc/firewalld/zones/public.xml)
<?xml version="1.0" encoding="utf-8"?>
<zone>
  <short>Public</short>
  <description>For use in public areas. You do not trust the other computers on networks to not harm your computer. Only selected incoming connections are accepted.</description>
  <service name="ssh"/>
  <service name="dhcpv6-client"/>
  <port protocol="tcp" port="80"/>
  <port protocol="tcp" port="443"/>
  <port protocol="udp" port="53"/>
  <port protocol="tcp" port="53"/>
  <port protocol="tcp" port="25"/>
  <port protocol="tcp" port="143"/>
  <port protocol="tcp" port="110"/>
  <port protocol="udp" port="123"/>
</zone>

# Internal zone configuration (/etc/firewalld/zones/internal.xml)
<?xml version="1.0" encoding="utf-8"?>
<zone>
  <short>Internal</short>
  <description>For use on internal networks. You mostly trust the other computers on networks to not harm your computer. Only selected incoming connections are accepted.</description>
  <service name="ssh"/>
  <service name="dhcpv6-client"/>
  <service name="mysql"/>
  <service name="postgresql"/>
  <service name="redis"/>
  <service name="mongodb"/>
  <port protocol="tcp" port="9200"/>
  <port protocol="tcp" port="5601"/>
  <port protocol="tcp" port="3000"/>
  <port protocol="tcp" port="9090"/>
  <source address="192.168.1.0/24"/>
</zone>

# =============================================================================
# FAIL2BAN CONFIGURATION
# =============================================================================

# Fail2ban configuration (/etc/fail2ban/jail.local)
[DEFAULT]
bantime = 3600
findtime = 600
maxretry = 3
backend = auto
usedns = warn

[sshd]
enabled = true
port = ssh
filter = sshd
logpath = /var/log/auth.log
maxretry = 3
bantime = 3600

[http-get-dos]
enabled = true
port = http,https
filter = http-get-dos
logpath = /var/log/apache2/access.log
maxretry = 300
findtime = 300
bantime = 600

# =============================================================================
# SECURITY RECOMMENDATIONS
# =============================================================================

# 1. Regularly update firewall rules
# 2. Monitor firewall logs
# 3. Use intrusion detection systems
# 4. Implement network segmentation
# 5. Regular security audits
# 6. Keep firewall software updated
# 7. Document all rule changes
# 8. Test rules in staging environment

# =============================================================================
# MONITORING COMMANDS
# =============================================================================

# Check iptables rules
# iptables -L -n -v

# Check iptables NAT rules
# iptables -t nat -L -n -v

# Check UFW status
# ufw status verbose

# Check firewalld status
# firewall-cmd --list-all

# Monitor firewall logs
# tail -f /var/log/iptables.log
# tail -f /var/log/ufw.log
# journalctl -f -u firewalld

# =============================================================================
# BACKUP AND RESTORE
# =============================================================================

# Backup iptables rules
# iptables-save > /etc/iptables/rules.v4

# Restore iptables rules
# iptables-restore < /etc/iptables/rules.v4

# Backup UFW rules
# ufw export > ufw-rules.txt

# Restore UFW rules
# ufw import < ufw-rules.txt

# Backup firewalld configuration
# firewall-cmd --list-all-zones > firewalld-backup.txt 